{"version":3,"file":"mathComponent.js","sourceRoot":"","sources":["../src/mathComponent.ts"],"names":[],"mappings":"AAAA;;;GAGG;AAEH,OAAO,EAAE,YAAY,EAAE,MAAM,QAAQ,CAAC;AACtC,OAAO,KAAK,QAAQ,MAAM,8BAA8B,CAAC;AACzD,OAAO,EAAE,KAAK,EAA0C,MAAM,8BAA8B,CAAC;AAW7F,OAAO,EAAE,iBAAiB,EAAE,MAAM,2BAA2B,CAAC;AAE9D,OAAO,EAAE,eAAe,EAAoB,MAAM,qBAAqB,CAAC;AACxE,OAAO,KAAK,SAAS,MAAM,4BAA4B,CAAC;AAExD,OAAO,KAAK,QAAQ,MAAM,0BAA0B,CAAC;AACrD,OAAO,EAAE,2BAA2B,EAAE,oBAAoB,EAAE,MAAM,kCAAkC,CAAC;AAErG,OAAO,KAAK,KAAK,MAAM,OAAO,CAAC;AAC/B,OAAO,KAAK,QAAQ,MAAM,YAAY,CAAC;AAEvC,MAAM,0BAA0B,GAAG;IAC/B,cAAgB,EAAE,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,IAAI;IACxD,eAAiB,EAAE,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,KAAK;IAC1D,aAAc,EAAE,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,EAAE;IACpD,cAAgB,EAAE,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,IAAI;IACxD,cAAgB,EAAE,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,OAAO;CAC9D,CAAC;AAEF,MAAM,0BAA0B,GAAG;IAC/B,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,IAAI,CAAC,cAAgB;IACxD,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,KAAK,CAAC,eAAiB;IAC1D,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,EAAE,CAAC,aAAc;IACpD,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,IAAI,CAAC,cAAgB;IACxD,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,OAAO,CAAC,cAAgB;CAC9D,CAAC;AAIF,MAAM,OAAO,QAAQ;IAgBjB,YAAmB,QAAsB,EAAE,KAAoB;QAA5C,aAAQ,GAAR,QAAQ,CAAc;QAXlC,iBAAY,GAAG,KAAK,CAAC;QAE5B,cAAc;QACP,cAAS,GAAG,IAAI,CAAC;QAEjB,eAAU,GAAG,CAAC,CAAC;QACf,mBAAc,GAAG,CAAC,CAAC;QAyBnB,eAAU,GAAG,CAAC,GAAW,EAAE,GAAW,EAAE,QAAiB,EAAE,EAAE;YAChE,IAAI,IAAI,CAAC,YAAY,EAAE;gBACnB,MAAM,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC;gBAC3C,IAAI,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC;gBACpC,IAAI,QAAQ,EAAE;oBACV,IAAI,GAAG,IAAI,aAAa,EAAE;wBACtB,aAAa,IAAI,GAAG,CAAC;qBACxB;iBACJ;qBAAM;oBACH,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC,IAAI,aAAa,EAAE;wBAC9B,aAAa,IAAI,GAAG,CAAC;qBACxB;yBAAM;wBACH,aAAa,GAAG,GAAG,CAAC;qBACvB;iBACJ;gBACD,IAAI,CAAC,UAAU,GAAG,aAAa,CAAC;gBAChC,IAAI,CAAC,cAAc,GAAG,QAAQ,CAAC,UAAU,CAAC,aAAa,EACnD,UAAU,CAAC,UAAU,CAAC,CAAC;aAC9B;YACD,IAAI,CAAC,WAAW,EAAE,CAAC;QACvB,CAAC,CAAC;QAvCE,IAAI,KAAK,EAAE;YACP,IAAI,CAAC,cAAc,GAAG,KAAK,CAAC,eAAe,CAAC;SAC/C;QACD,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC;QACrC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,YAAY,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC;IACpD,CAAC;IArBD,IAAW,cAAc,KAAK,OAAO,IAAI,CAAC,CAAC,CAAC;IAC5C,IAAW,WAAW,KAAK,OAAO,IAAI,CAAC,CAAC,CAAC;IACzC,IAAW,WAAW,KAAK,OAAO,IAAI,CAAC,CAAC,CAAC;IAqBzC,iBAAiB;IACV,MAAM,CAAC,gBAA6B,EAAE,OAA2B;QACpE,IAAI,OAAO,EAAE;YACT,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;SAC1B;QACD,IAAI,CAAC,SAAS,CAAC,gBAAgB,EAAE,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;IAC3D,CAAC;IAEM,MAAM;QACT,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,YAAY,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC;IACrD,CAAC;IAwBD,cAAc;IACP,KAAK,CAAC,SAA4C;QACrD,OAAO,CAAC,GAAG,CAAC,UAAU,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;QACtE,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QACzB,IAAI,SAAS,KAAK,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,KAAK,EAAE;YACvD,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;YACpB,IAAI,CAAC,cAAc,GAAG,CAAC,CAAC;SAC3B;aAAM,IAAI,SAAS,KAAK,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,IAAI,EAAE;YAC7D,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC;YAC7C,IAAI,CAAC,UAAU,GAAG,QAAQ,CAAC,MAAM,CAAC;YAClC,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,UAAU,CAAC,MAAM,CAAC;SACnE;IACL,CAAC;IAEM,KAAK,CAAC,SAA4C;QACrD,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC;IAC9B,CAAC;IAEM,GAAG;QACN,MAAM,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC;QAC3C,IAAI,CAAC,cAAc,GAAG,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,cAAc,EACzD,UAAU,CAAC,UAAU,CAAC,CAAC;QAC3B,IAAI,IAAI,CAAC,cAAc,KAAK,QAAQ,CAAC,IAAI,EAAE;YACvC,IAAI,CAAC,UAAU,GAAG,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,cAAc,EAAE,UAAU,CAAC,UAAU,CAAC,CAAC;SACrF;aAAM;YACH,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;YACpB,IAAI,CAAC,cAAc,GAAG,CAAC,CAAC;YACxB,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;YAC5D,OAAO,IAAI,CAAC;SACf;IACL,CAAC;IAEM,GAAG;QACN,MAAM,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC;QAC3C,IAAI,CAAC,cAAc,GAAG,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,cAAc,EACzD,UAAU,CAAC,UAAU,CAAC,CAAC;QAC3B,IAAI,IAAI,CAAC,cAAc,GAAG,UAAU,CAAC,UAAU,CAAC,MAAM,EAAE;YACpD,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;YAC7D,OAAO,IAAI,CAAC;SACf;aAAM,IAAI,IAAI,CAAC,cAAc,KAAK,UAAU,CAAC,UAAU,CAAC,MAAM,EAAE;YAC7D,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC;YAC7C,IAAI,CAAC,UAAU,GAAG,QAAQ,CAAC,MAAM,CAAC;SACrC;aAAM;YACH,IAAI,CAAC,UAAU,GAAG,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,cAAc,EAAE,UAAU,CAAC,UAAU,CAAC,CAAC;SACrF;IACL,CAAC;IAEM,YAAY;QACf,IAAI,CAAC,gBAAgB,CAAC,QAAQ,GAAG,CAAC,CAAC;QACnC,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,OAAO,GAAG,MAAM,CAAC;QAC7C,IAAI,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,OAAO,EAAE,GAAG,EAAE;YACjD,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;YACxB,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;YACpD,IAAI,CAAC,WAAW,EAAE,CAAC;QACvB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,MAAM,EAAE,GAAG,EAAE;YAChD,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;YACpD,IAAI,CAAC,WAAW,EAAE,CAAC;QACvB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,SAAS,EAAE,CAAC,CAAC,EAAE,EAAE;YACpD,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;QACtB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,UAAU,EAAE,CAAC,CAAC,EAAE,EAAE;YACrD,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;QACvB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,gBAAgB,CAAC,gBAAgB,iCAAuB,CAAC,CAAC,CAAc,EAAE,EAAE;YAC7E,2CAA2C;YAC3C,CAAC,CAAC,cAAc,EAAE,CAAC;YACnB,CAAC,CAAC,eAAe,EAAE,CAAC;YACpB,MAAM,eAAe,GAAG,0BAA0B,CAAC,CAAC,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;YACvE,OAAO,CAAC,GAAG,CAAC,eAAe,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,eAAe,CAAC,EAAE,CAAC,CAAC;YACjF,IAAI,CAAC,KAAK,CAAC,eAAe,CAAC,CAAC;QAChC,CAAC,CAAkB,CAAC,CAAC;IACzB,CAAC;IAEM,iBAAiB,CAAC,SAAmB,EAAE,GAAgB;QAC1D,IAAI,KAAK,GAAG,CAAC,CAAC;QACd,KAAK,MAAM,IAAI,IAAI,SAAS,EAAE;YAC1B,MAAM,OAAO,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YAC9C,GAAG,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;YACzB,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YAClC,IAAI,OAAO,IAAI,CAAC,EAAE;gBACd,MAAM,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,EAAE,OAAO,CAAC,CAAC;gBACzC,MAAM,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,OAAO,GAAG,CAAC,CAAC,CAAC;gBAC3C,MAAM,QAAQ,GAAG,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;gBAChD,QAAQ,CAAC,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC;gBAC7B,KAAK,CAAC,MAAM,CAAC,KAAK,EAAE,QAAQ,EACxB,EAAE,YAAY,EAAE,KAAK,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAC;gBAEhD,MAAM,KAAK,GAAG,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;gBAC7C,KAAK,CAAC,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC;gBAC1B,KAAK,CAAC,MAAM,CAAC,GAAG,EAAE,KAAK,EACnB,EAAE,YAAY,EAAE,KAAK,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAC;gBAChD,MAAM,SAAS,GAAG,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;gBACjD,SAAS,CAAC,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC;gBAC9B,KAAK,CAAC,MAAM,CAAC,MAAM,EAAE,SAAS,EAC1B,EAAE,YAAY,EAAE,KAAK,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAC;gBAChD,OAAO,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;gBAC9B,OAAO,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;gBAC3B,OAAO,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC;aAClC;iBAAM;gBACH,MAAM,KAAK,GAAG,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;gBAC7C,KAAK,CAAC,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC;gBAC1B,KAAK,CAAC,MAAM,CAAC,GAAG,EAAE,KAAK,EACnB,EAAE,YAAY,EAAE,KAAK,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAC;gBAChD,OAAO,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;aAC9B;YACD,MAAM,MAAM,GAAG,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;YAC9C,MAAM,CAAC,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC;YAC3B,KAAK,CAAC,MAAM,CAAC,SAAS,KAAK,EAAE,KAAK,EAAE,MAAM,EACtC,EAAE,YAAY,EAAE,KAAK,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAC;YAChD,OAAO,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;YAC5B,KAAK,EAAE,CAAC;SACX;IACL,CAAC;IAEM,YAAY,CAAC,SAAmB,EAAE,MAAiB;QACtD,IAAI,UAAU,GAAG,4BAA4B,CAAC;QAC9C,IAAI,KAAK,GAAG,CAAC,CAAC;QACd,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YACvC,IAAI,IAAI,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC;YACxB,IAAI,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;gBACpB,IAAI,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;aACrC;iBAAM;gBACH,IAAI,GAAG,KAAK,IAAI,IAAI,CAAC;aACxB;YACD,IAAI,YAAY,GAAG,gBAAgB,CAAC;YACpC,IAAI,MAAM,CAAC,CAAC,CAAC,EAAE;gBACX,YAAY,IAAI,mCAAmC,CAAC;aACvD;YACD,UAAU,IAAI,GAAG,IAAI,QAAQ,YAAY,gBAAgB,KAAK,EAAE,YAAY,CAAC;SAChF;QACD,UAAU,IAAI,eAAe,CAAC;QAC9B,OAAO,UAAU,CAAC;IACtB,CAAC;IAEM,SAAS,CAAC,GAAgB,EAAE,OAAgB;QAC/C,IAAI,QAAQ,GAAG,OAAO,CAAC;QACvB,IAAI,IAAI,CAAC,gBAAgB,KAAK,GAAG,EAAE;YAC/B,IAAI,CAAC,gBAAgB,GAAG,GAAG,CAAC;YAC5B,IAAI,CAAC,YAAY,EAAE,CAAC;SACvB;QACD,IAAI,QAAQ,KAAK,SAAS,EAAE;YACxB,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC;SACnC;QACD,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC;QAC7C,IAAI,UAAU,GAAG,QAAQ,CAAC;QAC1B,MAAM,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC;QAC3C,IAAI,CAAC,gBAAgB,GAAG,GAAG,CAAC;QAC5B,IAAI,UAAU,CAAC,UAAU,KAAK,SAAS,EAAE;YACrC,UAAU,CAAC,UAAU,GAAG,EAA0B,CAAC;YACnD,UAAU,CAAC,QAAQ,GAAG,EAAE,CAAC;SAC5B;QACD,IAAI,WAAwB,CAAC;QAC7B,IAAI,QAAQ,KAAK,QAAQ,EAAE;YACvB,WAAW,GAAG,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;YAC7C,WAAW,CAAC,KAAK,CAAC,UAAU,GAAG,KAAK,CAAC;YACrC,WAAW,CAAC,KAAK,CAAC,SAAS,GAAG,KAAK,CAAC;YACpC,WAAW,CAAC,KAAK,CAAC,WAAW,GAAG,KAAK,CAAC;YACtC,IAAI,IAAI,CAAC,YAAY,EAAE;gBACnB,WAAW,CAAC,KAAK,CAAC,UAAU,GAAG,kBAAkB,CAAC;gBAClD,WAAW,CAAC,KAAK,CAAC,WAAW,GAAG,kBAAkB,CAAC;gBACnD,aAAa;gBACb,UAAU,GAAG,UAAU,CAAC,SAAS,CAAC,CAAC,EAAE,IAAI,CAAC,UAAU,CAAC;oBACjD,QAAQ,CAAC,SAAS;oBAClB,UAAU,CAAC,SAAS,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;gBAC1C,UAAU,GAAG,QAAQ,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC;aACnD;YACD,KAAK,CAAC,MAAM,CAAC,UAAU,EAAE,WAAW,EAChC,EAAE,YAAY,EAAE,KAAK,EAAE,CAAC,CAAC;SAChC;aAAM;YACH,MAAM,SAAS,GAAG,IAAI,CAAC;YACvB,MAAM,SAAS,GAAG,IAAI,CAAC;YACvB,MAAM,MAAM,GAAG,EAAe,CAAC;YAC/B,WAAW,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YAC5C,MAAM,cAAc,GAAG,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;YAC9C,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,cAAc,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;gBAC5C,MAAM,SAAS,GAAG,cAAc,CAAC,CAAC,CAAC,CAAC;gBACpC,IAAI,SAAS,EAAE;oBACX,IAAI;wBACA,MAAM,CAAC,CAAC,CAAC,GAAG,QAAQ,CAAC,aAAa,CAAC,SAAS,EAAE,IAAI,CAAC,QAAQ,CAAC,OAAO,EAC/D,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;qBAC/B;oBAAC,OAAO,CAAC,EAAE;wBACR,OAAO,CAAC,GAAG,CAAC,eAAe,SAAS,EAAE,CAAC,CAAC;wBACxC,MAAM,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC;qBACrB;iBACJ;qBAAM;oBACH,MAAM,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC;iBACrB;aACJ;YACD,IAAI,IAAI,CAAC,YAAY,EAAE;gBACnB,aAAa;gBACb,UAAU,GAAG,UAAU,CAAC,SAAS,CAAC,CAAC,EAAE,IAAI,CAAC,UAAU,CAAC;oBACjD,QAAQ,CAAC,SAAS;oBAClB,UAAU,CAAC,SAAS,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;gBAC1C,UAAU,GAAG,QAAQ,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC;aACnD;YACD,MAAM,SAAS,GAAG,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;YACzC,IAAI,SAAS,EAAE;gBACX,UAAU,GAAG,IAAI,CAAC,YAAY,CAAC,SAAS,EAAE,MAAM,CAAC,CAAC;gBAClD,KAAK,CAAC,MAAM,CAAC,UAAU,EAAE,WAAW,EAChC,EAAE,YAAY,EAAE,KAAK,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAC;aACnD;iBAAM;gBACH,IAAI,CAAC,iBAAiB,CAAC,SAAS,EAAE,WAAW,CAAC,CAAC;aAClD;SACJ;QACD,IAAI,IAAI,CAAC,YAAY,EAAE;YACnB,MAAM,aAAa,GAAG,QAAQ,CAAC,QAAQ,CAAC,cAAc,CAAC,WAAW,EAC9D,CAAC,MAAmB,EAAE,EAAE,CAAC,MAAM,CAAC,KAAK,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,KAAK,QAAQ,CAAC,WAAW,CAAC,CAAC,CAAC;YAC5F,IAAI,aAAa,EAAE;gBACf,IAAI,CAAC,aAAa,GAAG,aAAa,CAAC;gBACnC,aAAa,CAAC,SAAS,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;aAC3C;SACJ;QACD,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;QAC/B,GAAG,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;IACjC,CAAC;IAEM,WAAW;QACd,IAAI,IAAI,CAAC,gBAAgB,EAAE;YACvB,QAAQ,CAAC,QAAQ,CAAC,YAAY,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YACtD,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,gBAAgB,EAAE,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;SAC/D;IACL,CAAC;IAEM,SAAS,CAAC,CAAgB;QAC7B,IAAI,CAAC,CAAC,OAAO,KAAK,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,SAAS,EAAE;YACnD,MAAM,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC;YAC3C,MAAM,YAAY,GAAG,QAAQ,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;YACrD,IAAI,YAAY,EAAE;gBACd,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,YAAY,CAAC,KAAK,EAAE,YAAY,CAAC,GAAG,CAAC,CAAC;aAClE;YACD,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACjE,UAAU,CAAC,QAAQ,GAAG,QAAQ,CAAC;YAC/B,UAAU,CAAC,UAAU,GAAG,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;YACnD,IAAI,CAAC,UAAU,GAAG,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,cAAc,EAAE,UAAU,CAAC,UAAU,CAAC,CAAC;YAClF,IAAI,IAAI,CAAC,gBAAgB,EAAE;gBACvB,QAAQ,CAAC,QAAQ,CAAC,YAAY,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;gBACtD,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,gBAAgB,EAAE,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;aAC/D;SACJ;aAAM,IAAI,CAAC,CAAC,OAAO,KAAK,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,UAAU,EAAE;YAC3D,IAAI,IAAI,CAAC,GAAG,EAAE,EAAE;gBACZ,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;aACvD;YACD,IAAI,CAAC,WAAW,EAAE,CAAC;SACtB;aAAM,IAAI,CAAC,CAAC,OAAO,KAAK,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,SAAS,EAAE;YAC1D,IAAI,IAAI,CAAC,GAAG,EAAE,EAAE;gBACZ,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;aACtD;YACD,IAAI,CAAC,WAAW,EAAE,CAAC;SACtB;IACL,CAAC;IAEM,UAAU,CAAC,IAAY;QAC1B,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,IAAI,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC;QAChD,MAAM,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC;QAC3C,IAAI,CAAC,cAAc,GAAG,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,cAAc,EAAE,UAAU,CAAC,UAAU,CAAC,CAAC;QACtF,IAAI,CAAC,UAAU,GAAG,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,cAAc,EAAE,UAAU,CAAC,UAAU,CAAC,CAAC;QAClF,OAAO,CAAC,GAAG,CAAC,sBAAsB,IAAI,CAAC,UAAU,aAAa,IAAI,EAAE,CAAC,CAAC;QACtE,IAAI,IAAI,CAAC,gBAAgB,EAAE;YACvB,QAAQ,CAAC,QAAQ,CAAC,YAAY,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YACtD,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,gBAAgB,EAAE,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;SACxE;IACL,CAAC;IAEM,cAAc,CAAC,GAAW;QAC7B,OAAO,CAAC,GAAG,CAAC,mBAAmB,GAAG,EAAE,CAAC,CAAC;QACtC,IAAI,GAAG,CAAC,UAAU,CAAC,WAAW,CAAC,EAAE;YAC7B,IAAI,CAAC,QAAQ,CAAC,QAAQ,GAAG,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;YAC1C,MAAM,CAAC,GAAG,QAAQ,CAAC,eAAe,CAAC,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;YAC3D,IAAI,CAAC,EAAE;gBACH,IAAI,CAAC,QAAQ,CAAC,OAAO,GAAG,CAAC,CAAC,IAAI,CAAC;aAClC;SACJ;IACL,CAAC;IAEM,UAAU,CAAC,CAAgB;QAC9B,IAAI,CAAC,CAAC,QAAQ,KAAK,QAAQ,CAAC,QAAQ,CAAC,cAAc,CAAC,SAAS,EAAE;YAC3D,IAAI,IAAI,CAAC,cAAc,EAAE;gBACrB,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,QAAQ,CAAC,WAAW,EAAE,KAAK,EAAE,IAAI,EAChE,CAAC,CAAC,EAAE,GAAG,EAAE,EAAE;oBACP,IAAI,GAAG,EAAE;wBACL,MAAM,IAAI,GAAI,GAA6B,CAAC,SAAS,CAAC;wBACtD,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;qBACzB;yBAAM;wBACH,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC;qBAC1B;gBACL,CAAC,CAAC,CAAC;aACV;SACJ;aAAM;YACH,MAAM,QAAQ,GAAG,QAAQ,CAAC,kBAAkB,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC;YACzD,IAAI,QAAQ,EAAE;gBACV,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;aAC7B;iBAAM;gBACH,OAAO,CAAC,GAAG,CAAC,2BAA2B,CAAC,CAAC,IAAI,EAAE,CAAC,CAAC;aACpD;SACJ;IACL,CAAC;IAEO,cAAc,CAAC,SAA4C;QAC/D,MAAM,aAAa,GAAG,QAAQ,CAAC,QAAQ,CAAC,cAAc,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC,MAAmB,EAAE,EAAE;YAClG,OAAO,MAAM,CAAC,KAAK,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,KAAK,QAAQ,CAAC,WAAW,CAAC,CAAC;QACzE,CAAC,CAAC,IAAI,IAAI,CAAC,gBAAgB,CAAC;QAE5B,KAAK,CAAC,UAAU,CAAC,IAAI,CAAC,gBAAgB,EAAE,0BAA0B,CAAC,SAAS,CAAC,EAAE,aAAa,CAAC,qBAAqB,EAAE,CAAC,CAAC;IAC1H,CAAC;CACJ;AAED,MAAM,OAAO,YAAa,SAAQ,YAAY;IAY1C,YACW,MAAc,EACrB,OAA4B,EACZ,UAA0B,EAC1B,UAAU,YAAY,CAAC,cAAc,EACrD,cAAc,GAAG,KAAK;QAEtB,KAAK,EAAE,CAAC;QAND,WAAM,GAAN,MAAM,CAAQ;QAEL,eAAU,GAAV,UAAU,CAAgB;QAC1B,YAAO,GAAP,OAAO,CAA8B;QAPlD,aAAQ,GAAG,KAAK,CAAC;QACjB,YAAO,GAAG,GAAG,CAAC;QAUjB,IAAI,CAAC,MAAM,GAAG,IAAI,iBAAiB,CAAC,IAAI,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;QAC3D,IAAI,CAAC,UAAU,CAAC,cAAc,CAAC,CAAC;IACpC,CAAC;IAnBD,IAAW,cAAc,KAAK,OAAO,IAAI,CAAC,CAAC,CAAC;IAC5C,IAAW,YAAY,KAAK,OAAO,IAAI,CAAC,CAAC,CAAC;IAoBnC,UAAU,CAAC,IAAY,EAAE,GAAW;QACvC,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,IAAI,EAAE,IAAI,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC;IACvD,CAAC;IAEM,UAAU,CAAC,QAAgB,EAAE,MAAc;QAC9C,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,IAAI,EAAE,QAAQ,EAAE,MAAM,CAAC,CAAC;IACvD,CAAC;IAEM,KAAK,CAAC,OAAO,CAAC,OAAiB;QAClC,OAAO;YACH,QAAQ,EAAE,cAAc;YACxB,MAAM,EAAE,GAAG;YACX,KAAK,EAAE,IAAI;SACd,CAAC;IACN,CAAC;IAEM,MAAM;IACb,CAAC;IAEM,UAAU,CAAC,GAAW,EAAE,GAAW,EAAE,QAAiB;QACzD,MAAM,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC;QAClC,MAAM,QAAQ,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QAC/C,UAAU,CAAC,UAAU,GAAG,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;QACnD,UAAU,CAAC,QAAQ,GAAG,QAAQ,CAAC;QAC/B,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,GAAG,EAAE,GAAG,EAAE,QAAQ,CAAC,CAAC;IAChD,CAAC;IAEM,UAAU;QACb,MAAM,QAAQ,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QAC/C,MAAM,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC;QAClC,UAAU,CAAC,QAAQ,GAAG,QAAQ,CAAC;QAC/B,UAAU,CAAC,UAAU,GAAG,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;IACvD,CAAC;IAEM,WAAW;QACd,OAAO,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;IACzC,CAAC;IAEO,UAAU,CAAC,cAAuB;QACtC,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC,IAAI,EAAE,cAAc,CAAC,CAAC;IAC5D,CAAC;;AA/Da,2BAAc,GAAiB,EAAE,OAAO,EAAE,QAAQ,EAAE,CAAC;AAkEvE,SAAS,WAAW,CAAC,YAAmC,EAAE,OAA2B;IACjF,OAAO,YAAY,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;AAC7C,CAAC;AAED,MAAM,WAAW,GAAG,MAAM,CAAC;AAK3B,MAAM,OAAO,cAAe,SAAQ,oBAAsC;IAQ/D,MAAM,CAAC,UAAU,KAA6B,OAAO,cAAc,CAAC,OAAO,CAAC,CAAC,CAAC;IAE9E,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,aAAqC,EAAE,KAAW;QACzE,OAAO,cAAc,CAAC,OAAO,CAAC,MAAM,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC;IAC/D,CAAC;IAEM,MAAM;QACT,IAAI,CAAC,gBAAgB,GAAG,QAAQ,CAAC,YAAY,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,EAAE,UAAU,CAAC,CAAC;QAC/E,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,UAAU,EAAE,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,CAAC;QACxD,IAAI,CAAC,UAAU,EAAE,CAAC;IACtB,CAAC;IAEM,KAAK,CAAC,IAAI;QACb,IAAI,CAAC,gBAAgB,GAAG,MAAM,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,IAAI,CAAsC,UAAU,CAAC,CAAC,CAAC,GAAG,EAAE,CAAC;QAC5G,IAAI,CAAC,UAAU,EAAE,CAAC;IACtB,CAAC;IAED,IAAW,cAAc,KAAK,OAAO,IAAI,CAAC,CAAC,CAAC;IAC5C,IAAW,sBAAsB,KAAK,OAAO,IAAI,CAAC,CAAC,CAAC;IACpD,IAAW,YAAY,KAAK,OAAO,IAAI,CAAC,CAAC,CAAC;IAInC,iBAAiB,CAAC,QAAsB,EAAE,cAAuB;QACpE,MAAM,KAAK,GAAG,WAAW,GAAG,QAAQ,CAAC,MAAM,CAAC;QAC5C,IAAI,CAAC,cAAc,EAAE;YACjB,IAAI,GAAG,GAAG,IAAI,CAAC,gBAAgB,CAAC,SAAS,EAAE,CAAC;YAC5C,IAAI,CAAC,gBAAgB,CAAC,YAAY,CAAC,GAAG,EAAE,EAAE,SAAS,CAAC,aAAa,CAAC,IAAI,EAAE;gBACpE,CAAC,SAAS,CAAC,qBAAqB,CAAC,EAAE,CAAC,MAAM,CAAC;gBAC3C,CAAC,SAAS,CAAC,mBAAmB,CAAC,EAAE,QAAQ,CAAC,MAAM;gBAChD,SAAS,EAAE,IAAI;aAClB,CAAC,CAAC;YACH,IAAI,CAAC,gBAAgB,CAAC,YAAY,CAAC,GAAG,EAAE,SAAS,CAAC,aAAa,CAAC,IAAI,EAAE;gBAClE,gBAAgB,EAAE,QAAQ,CAAC,OAAO;gBAClC,CAAC,SAAS,CAAC,qBAAqB,CAAC,EAAE,CAAC,MAAM,CAAC;gBAC3C,CAAC,SAAS,CAAC,mBAAmB,CAAC,EAAE,KAAK;gBACtC,OAAO,EAAE,IAAI;aAChB,CAAC,CAAC;SACN;QACD,IAAI,GAAG,GAAG,IAAI,CAAC,gBAAgB,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;QACvD,MAAM,UAAU,GAAG,GAA2B,CAAC;QAC/C,QAAQ,CAAC,SAAS,GAAG,UAAU,CAAC;QAChC,UAAU,CAAC,YAAY,GAAG,QAAQ,CAAC;QACnC,GAAG,GAAG,IAAI,CAAC,gBAAgB,CAAC,eAAe,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;QAC7D,QAAQ,CAAC,WAAW,GAAG,GAAuB,CAAC;QAC/C,UAAU,CAAC,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;QAC7C,UAAU,CAAC,UAAU,GAAG,QAAQ,CAAC,OAAO,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;IAClE,CAAC;IAEM,oBAAoB,CAAC,OAAsB;QAC9C,MAAM,MAAM,GAAG,QAAQ,IAAI,CAAC,GAAG,EAAE,EAAE,CAAC;QACpC,OAAO,IAAI,YAAY,CAAC,MAAM,EAAE,IAAI,CAAC,OAAO,CAAC,qBAAqB,EAAE,IAAI,EAAE,OAAO,CAAC,CAAC;IACvF,CAAC;IAEM,OAAO,CAAC,QAAsB;QACjC,MAAM,YAAY,GAAG,IAAI,CAAC,gBAAgB,CAAC;QAC3C,MAAM,WAAW,GAAG,QAAQ,CAAC,WAAW,CAAC;QACzC,MAAM,KAAK,GAAG,WAAW,CAAC,YAAY,EAAE,WAAW,CAAC,GAAG,WAAW,CAAC,YAAY,CAAC;QAChF,MAAM,SAAS,GAAG,QAAQ,CAAC,SAAS,CAAC;QACrC,MAAM,GAAG,GAAG,WAAW,CAAC,YAAY,EAAE,SAAS,CAAC,CAAC;QACjD,OAAO,IAAI,CAAC,gBAAgB,CAAC,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;IACrD,CAAC;IAEM,oBAAoB,CAAC,QAAsB;QAC9C,MAAM,YAAY,GAAG,IAAI,CAAC,gBAAgB,CAAC;QAC3C,MAAM,WAAW,GAAG,QAAQ,CAAC,WAAW,CAAC;QACzC,MAAM,KAAK,GAAG,WAAW,CAAC,YAAY,EAAE,WAAW,CAAC,CAAC;QACrD,MAAM,SAAS,GAAG,QAAQ,CAAC,SAAS,CAAC;QACrC,MAAM,GAAG,GAAG,WAAW,CAAC,YAAY,EAAE,SAAS,CAAC,GAAG,SAAS,CAAC,YAAY,CAAC;QAC1E,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;IAClD,CAAC;IAEM,KAAK,CAAC,OAAO,CAAC,OAAiB;QAClC,mCAAmC;QACnC,MAAM,UAAU,GAAG,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC;QAErF,iDAAiD;QACjD,MAAM,UAAU,GAAG,UAAU;aACxB,MAAM,CAAC,CAAC,EAAE,CAAC,UAAU,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC,UAAU,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC;QAE3F,6EAA6E;QAC7E,IAAI,CAAC,UAAU,EAAE;YACb,OAAO;gBACH,QAAQ,EAAE,cAAc;gBACxB,MAAM,EAAE,GAAG;gBACX,KAAK,EAAE,IAAI;aACd,CAAC;SACL;QAED,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;QAC9C,2DAA2D;QAC3D,MAAM,cAAc,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,CAAC;QACpC,IAAI,QAAQ,KAAK,SAAS,EAAE;YACxB,OAAO,QAAQ,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;SAC3C;IACL,CAAC;IAEM,UAAU,CAAC,IAAY,EAAE,UAAkB,EAAE,MAAc;QAC9D,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;QAC9C,MAAM,GAAG,GAAG,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,GAAG,MAAM,CAAC;QAChD,IAAI,CAAC,gBAAgB,CAAC,UAAU,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;QAC5C,QAAQ,CAAC,UAAU,EAAE,CAAC;IAC1B,CAAC;IAEM,UAAU,CAAC,QAAsB,EAAE,KAAa,EAAE,GAAW;QAChE,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;QAC5C,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAC,QAAQ,GAAG,KAAK,EAAE,QAAQ,GAAG,GAAG,CAAC,CAAC;IACxE,CAAC;IAEM,WAAW,CAAC,EAAU,EAAE,OAAO,GAAG,YAAY,CAAC,cAAc;QAChE,IAAI,QAAQ,GAAG,OAAO,CAAC;QACvB,MAAM,KAAK,GAAG,WAAW,GAAG,EAAE,CAAC;QAC/B,MAAM,UAAU,GAAG,IAAI,CAAC,gBAAgB,CAAC,eAAe,CAAC,KAAK,CAAoB,CAAC;QACnF,IAAI,UAAU,KAAK,SAAS,EAAE;YAC1B,IAAI,CAAC,UAAU,CAAC,YAAY,EAAE;gBAC1B,IAAI,UAAU,CAAC,UAAU,CAAC,gBAAgB,EAAE;oBACxC,QAAQ,GAAG,UAAU,CAAC,UAAU,CAAC,gBAAgB,CAAC;iBACrD;gBACD,UAAU,CAAC,YAAY,GAAG,IAAI,YAAY,CAAC,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,qBAAqB,EAAE,IAAI,EAAE,QAAQ,EAAE,IAAI,CAAC,CAAC;aAC5G;YACD,OAAO,UAAU,CAAC,YAA4B,CAAC;SAClD;IACL,CAAC;IAEO,WAAW,CAAC,QAAsB;QACtC,MAAM,YAAY,GAAG,IAAI,CAAC,gBAAgB,CAAC;QAC3C,MAAM,WAAW,GAAG,QAAQ,CAAC,WAAW,CAAC;QACzC,MAAM,KAAK,GAAG,WAAW,CAAC,YAAY,EAAE,WAAW,CAAC,CAAC;QACrD,OAAO,KAAK,GAAG,WAAW,CAAC,YAAY,CAAC;IAC5C,CAAC;IAEO,QAAQ,CAAC,QAAgB,EAAE,QAAgB,EAAE,SAAkB;QACnE,OAAO,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,QAAQ,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC;IACzE,CAAC;IAEO,UAAU;QACd,0HAA0H;QAC1H,OAAO,CAAC,0BAA0B,CAAC,CAAC;QACpC,8FAA8F;QAC9F,OAAO,CAAC,aAAa,CAAC,CAAC;QAEvB,IAAI,CAAC,gBAAgB,CAAC,EAAE,CAAC,eAAe,EAAE,CAAC,KAAK,EAAE,EAAE;YAChD,IAAI,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,KAAK,UAAU,CAAC,EAAE;gBAClF,IAAI,GAAW,CAAC;gBAChB,IAAI,GAAG,GAAG,CAAC,CAAC;gBACZ,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,KAAK,EAAE,EAAE;oBAC3B,GAAG,GAAG,KAAK,CAAC,QAAQ,CAAC;oBACrB,GAAG,IAAI,KAAK,CAAC,OAAO,CAAC,YAAY,CAAC;gBACtC,CAAC,CAAC,CAAC;gBACH,+DAA+D;gBAC/D,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,EAAE,MAAM,EAAE,KAAK,CAAC,CAAC;gBACnD,IAAI,QAAQ,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,EAAE;oBAChD,MAAM,UAAU,GAAG,QAAQ,CAAC,IAAuB,CAAC;oBACpD,MAAM,MAAM,GAAG,UAAU,CAAC,KAAK,EAAE,CAAC,SAAS,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;oBAChE,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;oBAC1C,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;oBAC5C,QAAQ,CAAC,UAAU,CAAC,GAAG,GAAG,QAAQ,EAAE,GAAG,EAAE,KAAK,CAAC,cAAc,mBAAwC,CAAC,CAAC;iBAC1G;aACJ;QACL,CAAC,CAAC,CAAC;IACP,CAAC;;AAvKuB,sBAAO,GAAG,IAAI,2BAA2B,CAC7D,qBAAqB,EACrB,cAAc;AACd,WAAW,CAAC,eAAe,CAAC,UAAU,EAAE,EACxC,CAAC,QAAQ,CAAC,YAAY,CAAC,UAAU,EAAE,CAAC,CACvC,CAAC;AAqKN,MAAM,CAAC,MAAM,WAAW,GAA2B,cAAc,CAAC,UAAU,EAAE,CAAC","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation and contributors. All rights reserved.\n * Licensed under the MIT License.\n */\n\nimport { EventEmitter } from \"events\";\nimport * as ClientUI from \"@fluid-example/client-ui-lib\";\nimport { Caret, CaretEventType, Direction, ICaretEvent } from \"@fluid-example/flow-util-lib\";\nimport * as SearchMenu from \"@fluid-example/search-menu\";\nimport {\n    IFluidObject,\n    IFluidHandleContext,\n    IFluidLoadable,\n    IFluidRouter,\n    IRequest,\n    IResponse,\n    IFluidHandle,\n} from \"@fluidframework/core-interfaces\";\nimport { FluidObjectHandle } from \"@fluidframework/datastore\";\nimport { IFluidObjectCollection } from \"@fluid-example/fluid-object-interfaces\";\nimport { SharedDirectory, ISharedDirectory } from \"@fluidframework/map\";\nimport * as MergeTree from \"@fluidframework/merge-tree\";\nimport { IFluidDataStoreContext, IFluidDataStoreFactory } from \"@fluidframework/runtime-definitions\";\nimport * as Sequence from \"@fluidframework/sequence\";\nimport { LazyLoadedDataObjectFactory, LazyLoadedDataObject } from \"@fluidframework/data-object-base\";\nimport { IFluidHTMLOptions, IFluidHTMLView } from \"@fluidframework/view-interfaces\";\nimport * as Katex from \"katex\";\nimport * as MathExpr from \"./mathExpr\";\n\nconst directionToCursorDirection = {\n    [Direction.left]: ClientUI.controls.CursorDirection.Left,\n    [Direction.right]: ClientUI.controls.CursorDirection.Right,\n    [Direction.up]: ClientUI.controls.CursorDirection.Up,\n    [Direction.down]: ClientUI.controls.CursorDirection.Down,\n    [Direction.none]: ClientUI.controls.CursorDirection.Airlift,\n};\n\nconst cursorDirectionToDirection = {\n    [ClientUI.controls.CursorDirection.Left]: Direction.left,\n    [ClientUI.controls.CursorDirection.Right]: Direction.right,\n    [ClientUI.controls.CursorDirection.Up]: Direction.up,\n    [ClientUI.controls.CursorDirection.Down]: Direction.down,\n    [ClientUI.controls.CursorDirection.Airlift]: Direction.none,\n};\n\ntype IMathMarkerInst = MathExpr.IMathMarker;\n\nexport class MathView implements IFluidHTMLView, ClientUI.controls.IViewCursor, ClientUI.controls.IViewLayout {\n    public get IFluidHTMLView() { return this; }\n    public get IViewCursor() { return this; }\n    public get IViewLayout() { return this; }\n\n    public cursorActive = false;\n    public cursorElement: HTMLElement;\n    // IViewLayout\n    public canInline = true;\n    public containerElement: HTMLElement;\n    public mathCursor = 0;\n    public mathTokenIndex = 0;\n    public searchMenuHost: SearchMenu.ISearchMenuHost;\n    public options?: IFluidHTMLOptions;\n    public rootElement: HTMLElement;\n\n    constructor(public instance: MathInstance, scope?: IFluidObject) {\n        if (scope) {\n            this.searchMenuHost = scope.ISearchMenuHost;\n        }\n        this.options = this.instance.options;\n        this.instance.on(\"remoteEdit\", this.remoteEdit);\n    }\n\n    // IFluidHTMLView\n    public render(containerElement: HTMLElement, options?: IFluidHTMLOptions) {\n        if (options) {\n            this.options = options;\n        }\n        this.buildTree(containerElement, this.options.display);\n    }\n\n    public remove() {\n        this.instance.off(\"remoteEdit\", this.remoteEdit);\n    }\n\n    public remoteEdit = (pos: number, len: number, isInsert: boolean) => {\n        if (this.cursorActive) {\n            const mathMarker = this.instance.endMarker;\n            let mathCursorNew = this.mathCursor;\n            if (isInsert) {\n                if (pos <= mathCursorNew) {\n                    mathCursorNew += len;\n                }\n            } else {\n                if ((pos + len) <= mathCursorNew) {\n                    mathCursorNew -= len;\n                } else {\n                    mathCursorNew = pos;\n                }\n            }\n            this.mathCursor = mathCursorNew;\n            this.mathTokenIndex = MathExpr.tokenAtPos(mathCursorNew,\n                mathMarker.mathTokens);\n        }\n        this.localRender();\n    };\n\n    // IViewCursor\n    public enter(direction: ClientUI.controls.CursorDirection) {\n        console.log(`enter: ${ClientUI.controls.CursorDirection[direction]}`);\n        this.cursorActive = true;\n        if (direction === ClientUI.controls.CursorDirection.Right) {\n            this.mathCursor = 0;\n            this.mathTokenIndex = 0;\n        } else if (direction === ClientUI.controls.CursorDirection.Left) {\n            const mathText = this.instance.getMathText();\n            this.mathCursor = mathText.length;\n            this.mathTokenIndex = this.instance.endMarker.mathTokens.length;\n        }\n    }\n\n    public leave(direction: ClientUI.controls.CursorDirection) {\n        this.cursorActive = false;\n    }\n\n    public rev() {\n        const mathMarker = this.instance.endMarker;\n        this.mathTokenIndex = MathExpr.mathTokRev(this.mathTokenIndex,\n            mathMarker.mathTokens);\n        if (this.mathTokenIndex !== MathExpr.Nope) {\n            this.mathCursor = MathExpr.posAtToken(this.mathTokenIndex, mathMarker.mathTokens);\n        } else {\n            this.mathCursor = 0;\n            this.mathTokenIndex = 0;\n            this.noteCursorExit(ClientUI.controls.CursorDirection.Left);\n            return true;\n        }\n    }\n\n    public fwd() {\n        const mathMarker = this.instance.endMarker;\n        this.mathTokenIndex = MathExpr.mathTokFwd(this.mathTokenIndex,\n            mathMarker.mathTokens);\n        if (this.mathTokenIndex > mathMarker.mathTokens.length) {\n            this.noteCursorExit(ClientUI.controls.CursorDirection.Right);\n            return true;\n        } else if (this.mathTokenIndex === mathMarker.mathTokens.length) {\n            const mathText = this.instance.getMathText();\n            this.mathCursor = mathText.length;\n        } else {\n            this.mathCursor = MathExpr.posAtToken(this.mathTokenIndex, mathMarker.mathTokens);\n        }\n    }\n\n    public setListeners() {\n        this.containerElement.tabIndex = 0;\n        this.containerElement.style.outline = \"none\";\n        this.containerElement.addEventListener(\"focus\", () => {\n            console.log(\"focus...\");\n            this.enter(ClientUI.controls.CursorDirection.Focus);\n            this.localRender();\n        });\n        this.containerElement.addEventListener(\"blur\", () => {\n            this.leave(ClientUI.controls.CursorDirection.Focus);\n            this.localRender();\n        });\n        this.containerElement.addEventListener(\"keydown\", (e) => {\n            this.onKeydown(e);\n        });\n        this.containerElement.addEventListener(\"keypress\", (e) => {\n            this.onKeypress(e);\n        });\n        this.containerElement.addEventListener(CaretEventType.enter, ((e: ICaretEvent) => {\n            // Let caller know we've handled the event:\n            e.preventDefault();\n            e.stopPropagation();\n            const cursorDirection = directionToCursorDirection[e.detail.direction];\n            console.log(`caret event ${ClientUI.controls.CursorDirection[cursorDirection]}`);\n            this.enter(cursorDirection);\n        }) as EventListener);\n    }\n\n    public buildAlignedAsDiv(mathLines: string[], elm: HTMLElement) {\n        let count = 1;\n        for (const line of mathLines) {\n            const lineDiv = document.createElement(\"div\");\n            elm.appendChild(lineDiv);\n            const eqIndex = line.indexOf(\"=\");\n            if (eqIndex >= 0) {\n                const preEq = line.substring(0, eqIndex);\n                const postEq = line.substring(eqIndex + 1);\n                const preEqElm = document.createElement(\"span\");\n                preEqElm.style.width = \"35%\";\n                Katex.render(preEq, preEqElm,\n                    { throwOnError: false, displayMode: true });\n\n                const eqElm = document.createElement(\"span\");\n                eqElm.style.width = \"10%\";\n                Katex.render(\"=\", eqElm,\n                    { throwOnError: false, displayMode: true });\n                const postEqElm = document.createElement(\"span\");\n                postEqElm.style.width = \"35%\";\n                Katex.render(postEq, postEqElm,\n                    { throwOnError: false, displayMode: true });\n                lineDiv.appendChild(preEqElm);\n                lineDiv.appendChild(eqElm);\n                lineDiv.appendChild(postEqElm);\n            } else {\n                const eqElm = document.createElement(\"span\");\n                eqElm.style.width = \"80%\";\n                Katex.render(\"=\", eqElm,\n                    { throwOnError: false, displayMode: true });\n                lineDiv.appendChild(eqElm);\n            }\n            const tagElm = document.createElement(\"span\");\n            tagElm.style.width = \"20%\";\n            Katex.render(`\\\\tag{${count++}}{}`, tagElm,\n                { throwOnError: false, displayMode: true });\n            lineDiv.appendChild(tagElm);\n            count++;\n        }\n    }\n\n    public buildAligned(mathLines: string[], checks: boolean[]) {\n        let mathBuffer = \"\\\\begin{darray}{rcllcr} \\n\";\n        let count = 1;\n        for (let i = 0; i < mathLines.length; i++) {\n            let line = mathLines[i];\n            if (line.includes(\"=\")) {\n                line = line.replace(\"=\", \"& = &\");\n            } else {\n                line = `& ${line} &`;\n            }\n            let rightContext = \"\\\\hspace{20ex}\";\n            if (checks[i]) {\n                rightContext += \"\\\\textcolor{#008000}{\\\\checkmark}\";\n            }\n            mathBuffer += `${line} & & ${rightContext} & \\\\textrm{(${count++})} \\\\\\\\ \\n`;\n        }\n        mathBuffer += \"\\\\end{darray}\";\n        return mathBuffer;\n    }\n\n    public buildTree(elm: HTMLElement, display?: string) {\n        let _display = display;\n        if (this.containerElement !== elm) {\n            this.containerElement = elm;\n            this.setListeners();\n        }\n        if (_display === undefined) {\n            _display = this.options.display;\n        }\n        const mathText = this.instance.getMathText();\n        let mathBuffer = mathText;\n        const mathMarker = this.instance.endMarker;\n        this.containerElement = elm;\n        if (mathMarker.mathTokens === undefined) {\n            mathMarker.mathTokens = [] as MathExpr.MathToken[];\n            mathMarker.mathText = \"\";\n        }\n        let rootElement: HTMLElement;\n        if (_display === \"inline\") {\n            rootElement = document.createElement(\"span\");\n            rootElement.style.marginLeft = \"2px\";\n            rootElement.style.marginTop = \"4px\";\n            rootElement.style.marginRight = \"2px\";\n            if (this.cursorActive) {\n                rootElement.style.borderLeft = \"solid orange 2px\";\n                rootElement.style.borderRight = \"solid orange 2px\";\n                // showCursor\n                mathBuffer = mathBuffer.substring(0, this.mathCursor) +\n                    MathExpr.cursorTex +\n                    mathBuffer.substring(this.mathCursor);\n                mathBuffer = MathExpr.boxEmptyParam(mathBuffer);\n            }\n            Katex.render(mathBuffer, rootElement,\n                { throwOnError: false });\n        } else {\n            const useDarray = true;\n            const checkSoln = true;\n            const checks = [] as boolean[];\n            rootElement = document.createElement(\"div\");\n            const cleanMathLines = mathBuffer.split(\"\\n\");\n            for (let i = 0; i < cleanMathLines.length; i++) {\n                const cleanLine = cleanMathLines[i];\n                if (checkSoln) {\n                    try {\n                        checks[i] = MathExpr.matchSolution(cleanLine, this.instance.solnVar,\n                            this.instance.solnText);\n                    } catch (e) {\n                        console.log(`match soln: ${cleanLine}`);\n                        checks[i] = false;\n                    }\n                } else {\n                    checks[i] = false;\n                }\n            }\n            if (this.cursorActive) {\n                // showCursor\n                mathBuffer = mathBuffer.substring(0, this.mathCursor) +\n                    MathExpr.cursorTex +\n                    mathBuffer.substring(this.mathCursor);\n                mathBuffer = MathExpr.boxEmptyParam(mathBuffer);\n            }\n            const mathLines = mathBuffer.split(\"\\n\");\n            if (useDarray) {\n                mathBuffer = this.buildAligned(mathLines, checks);\n                Katex.render(mathBuffer, rootElement,\n                    { throwOnError: false, displayMode: true });\n            } else {\n                this.buildAlignedAsDiv(mathLines, rootElement);\n            }\n        }\n        if (this.cursorActive) {\n            const cursorElement = ClientUI.controls.findFirstMatch(rootElement,\n                (cursor: HTMLElement) => cursor.style && (cursor.style.color === MathExpr.cursorColor));\n            if (cursorElement) {\n                this.cursorElement = cursorElement;\n                cursorElement.classList.add(\"blinking\");\n            }\n        }\n        this.rootElement = rootElement;\n        elm.appendChild(rootElement);\n    }\n\n    public localRender() {\n        if (this.containerElement) {\n            ClientUI.controls.clearSubtree(this.containerElement);\n            this.buildTree(this.containerElement, this.options.display);\n        }\n    }\n\n    public onKeydown(e: KeyboardEvent) {\n        if (e.keyCode === ClientUI.controls.KeyCode.backspace) {\n            const mathMarker = this.instance.endMarker;\n            const toRemoveMath = MathExpr.bksp(mathMarker, this);\n            if (toRemoveMath) {\n                this.instance.removeText(toRemoveMath.start, toRemoveMath.end);\n            }\n            const mathText = this.instance.collection.getText(this.instance);\n            mathMarker.mathText = mathText;\n            mathMarker.mathTokens = MathExpr.lexMath(mathText);\n            this.mathCursor = MathExpr.posAtToken(this.mathTokenIndex, mathMarker.mathTokens);\n            if (this.containerElement) {\n                ClientUI.controls.clearSubtree(this.containerElement);\n                this.buildTree(this.containerElement, this.options.display);\n            }\n        } else if (e.keyCode === ClientUI.controls.KeyCode.rightArrow) {\n            if (this.fwd()) {\n                this.leave(ClientUI.controls.CursorDirection.Right);\n            }\n            this.localRender();\n        } else if (e.keyCode === ClientUI.controls.KeyCode.leftArrow) {\n            if (this.rev()) {\n                this.leave(ClientUI.controls.CursorDirection.Left);\n            }\n            this.localRender();\n        }\n    }\n\n    public insertText(text: string) {\n        this.instance.insertText(text, this.mathCursor);\n        const mathMarker = this.instance.endMarker;\n        this.mathTokenIndex = MathExpr.mathTokFwd(this.mathTokenIndex, mathMarker.mathTokens);\n        this.mathCursor = MathExpr.posAtToken(this.mathTokenIndex, mathMarker.mathTokens);\n        console.log(`set math cursor to ${this.mathCursor} on input ${text}`);\n        if (this.containerElement) {\n            ClientUI.controls.clearSubtree(this.containerElement);\n            this.buildTree(this.containerElement, this.instance.options.display);\n        }\n    }\n\n    public specialCommand(cmd: string) {\n        console.log(`special command ${cmd}`);\n        if (cmd.startsWith(\"solution \")) {\n            this.instance.solnText = cmd.substring(9);\n            const v = MathExpr.extractFirstVar(this.instance.solnText);\n            if (v) {\n                this.instance.solnVar = v.text;\n            }\n        }\n    }\n\n    public onKeypress(e: KeyboardEvent) {\n        if (e.charCode === ClientUI.controls.CharacterCodes.backslash) {\n            if (this.searchMenuHost) {\n                this.searchMenuHost.showSearchMenu(MathExpr.mathCmdTree, false, true,\n                    (s, cmd) => {\n                        if (cmd) {\n                            const text = (cmd as MathExpr.IMathCommand).texString;\n                            this.insertText(text);\n                        } else {\n                            this.specialCommand(s);\n                        }\n                    });\n            }\n        } else {\n            const toInsert = MathExpr.transformInputCode(e.charCode);\n            if (toInsert) {\n                this.insertText(toInsert);\n            } else {\n                console.log(`unrecognized math input ${e.char}`);\n            }\n        }\n    }\n\n    private noteCursorExit(direction: ClientUI.controls.CursorDirection) {\n        const cursorElement = ClientUI.controls.findFirstMatch(this.containerElement, (cursor: HTMLElement) => {\n            return cursor.style && (cursor.style.color === MathExpr.cursorColor);\n        }) || this.containerElement;\n\n        Caret.caretLeave(this.containerElement, cursorDirectionToDirection[direction], cursorElement.getBoundingClientRect());\n    }\n}\n\nexport class MathInstance extends EventEmitter implements IFluidLoadable, IFluidRouter {\n    public static defaultOptions: IMathOptions = { display: \"inline\" };\n\n    public get IFluidLoadable() { return this; }\n    public get IFluidRouter() { return this; }\n\n    public handle: FluidObjectHandle;\n    public endMarker: IMathMarkerInst;\n    public startMarker: MergeTree.Marker;\n    public solnText = \"x=0\";\n    public solnVar = \"x\";\n\n    constructor(\n        public leafId: string,\n        context: IFluidHandleContext,\n        public readonly collection: MathCollection,\n        public readonly options = MathInstance.defaultOptions,\n        inCombinedText = false,\n    ) {\n        super();\n        this.handle = new FluidObjectHandle(this, leafId, context);\n        this.initialize(inCombinedText);\n    }\n\n    public insertText(text: string, pos: number) {\n        this.collection.insertText(text, this.leafId, pos);\n    }\n\n    public removeText(startPos: number, endPos: number) {\n        this.collection.removeText(this, startPos, endPos);\n    }\n\n    public async request(request: IRequest): Promise<IResponse> {\n        return {\n            mimeType: \"fluid/object\",\n            status: 200,\n            value: this,\n        };\n    }\n\n    public detach() {\n    }\n\n    public remoteEdit(pos: number, len: number, isInsert: boolean) {\n        const mathMarker = this.endMarker;\n        const mathText = this.collection.getText(this);\n        mathMarker.mathTokens = MathExpr.lexMath(mathText);\n        mathMarker.mathText = mathText;\n        this.emit(\"remoteEdit\", pos, len, isInsert);\n    }\n\n    public postInsert() {\n        const mathText = this.collection.getText(this);\n        const mathMarker = this.endMarker;\n        mathMarker.mathText = mathText;\n        mathMarker.mathTokens = MathExpr.lexMath(mathText);\n    }\n\n    public getMathText() {\n        return this.collection.getText(this);\n    }\n\n    private initialize(inCombinedText: boolean) {\n        this.collection.appendMathMarkers(this, inCombinedText);\n    }\n}\n\nfunction getPosition(sharedString: Sequence.SharedString, segment: MergeTree.ISegment) {\n    return sharedString.getPosition(segment);\n}\n\nconst endIdPrefix = \"end-\";\n\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\nexport interface IMathOptions extends IFluidHTMLOptions { }\n\nexport class MathCollection extends LazyLoadedDataObject<ISharedDirectory> implements IFluidObjectCollection {\n    private static readonly factory = new LazyLoadedDataObjectFactory<MathCollection>(\n        \"@fluid-example/math\",\n        MathCollection,\n        /* root: */ SharedDirectory.getFactory(),\n        [Sequence.SharedString.getFactory()],\n    );\n\n    public static getFactory(): IFluidDataStoreFactory { return MathCollection.factory; }\n\n    public static async create(parentContext: IFluidDataStoreContext, props?: any) {\n        return MathCollection.factory.create(parentContext, props);\n    }\n\n    public create() {\n        this.combinedMathText = Sequence.SharedString.create(this.runtime, \"mathText\");\n        this.root.set(\"mathText\", this.combinedMathText.handle);\n        this.initialize();\n    }\n\n    public async load() {\n        this.combinedMathText = await (await this.root.wait<IFluidHandle<Sequence.SharedString>>(\"mathText\")).get();\n        this.initialize();\n    }\n\n    public get IFluidLoadable() { return this; }\n    public get IFluidObjectCollection() { return this; }\n    public get IFluidRouter() { return this; }\n\n    private combinedMathText: Sequence.SharedString;\n\n    public appendMathMarkers(instance: MathInstance, inCombinedText: boolean) {\n        const endId = endIdPrefix + instance.leafId;\n        if (!inCombinedText) {\n            let pos = this.combinedMathText.getLength();\n            this.combinedMathText.insertMarker(pos++, MergeTree.ReferenceType.Tile, {\n                [MergeTree.reservedTileLabelsKey]: [\"math\"],\n                [MergeTree.reservedMarkerIdKey]: instance.leafId,\n                mathStart: true,\n            });\n            this.combinedMathText.insertMarker(pos, MergeTree.ReferenceType.Tile, {\n                componentOptions: instance.options,\n                [MergeTree.reservedTileLabelsKey]: [\"math\"],\n                [MergeTree.reservedMarkerIdKey]: endId,\n                mathEnd: true,\n            });\n        }\n        let seg = this.combinedMathText.getMarkerFromId(endId);\n        const mathMarker = seg as MathExpr.IMathMarker;\n        instance.endMarker = mathMarker;\n        mathMarker.mathInstance = instance;\n        seg = this.combinedMathText.getMarkerFromId(instance.leafId);\n        instance.startMarker = seg as MergeTree.Marker;\n        mathMarker.mathText = this.getText(instance);\n        mathMarker.mathTokens = MathExpr.lexMath(mathMarker.mathText);\n    }\n\n    public createCollectionItem(options?: IMathOptions): MathInstance {\n        const leafId = `math-${Date.now()}`;\n        return new MathInstance(leafId, this.runtime.objectsRoutingContext, this, options);\n    }\n\n    public getText(instance: MathInstance) {\n        const sharedString = this.combinedMathText;\n        const startMarker = instance.startMarker;\n        const start = getPosition(sharedString, startMarker) + startMarker.cachedLength;\n        const endMarker = instance.endMarker;\n        const end = getPosition(sharedString, endMarker);\n        return this.combinedMathText.getText(start, end);\n    }\n\n    public removeCollectionItem(instance: MathInstance) {\n        const sharedString = this.combinedMathText;\n        const startMarker = instance.startMarker;\n        const start = getPosition(sharedString, startMarker);\n        const endMarker = instance.endMarker;\n        const end = getPosition(sharedString, endMarker) + endMarker.cachedLength;\n        this.combinedMathText.removeRange(start, end);\n    }\n\n    public async request(request: IRequest): Promise<IResponse> {\n        // Trim leading slash, if it exists\n        const trimmedUrl = request.url.startsWith(\"/\") ? request.url.substr(1) : request.url;\n\n        // Next segment is math instance id, if it exists\n        const instanceId = trimmedUrl\n            .substr(0, !trimmedUrl.includes(\"/\", 1) ? trimmedUrl.length : trimmedUrl.indexOf(\"/\"));\n\n        // If no instance is requested, then the collection itself is being requested\n        if (!instanceId) {\n            return {\n                mimeType: \"fluid/object\",\n                status: 200,\n                value: this,\n            };\n        }\n\n        const instance = this.getInstance(instanceId);\n        // FIX this using a routing toolkit (don't end route here!)\n        const trimmedRequest = { url: \"/\" };\n        if (instance !== undefined) {\n            return instance.request(trimmedRequest);\n        }\n    }\n\n    public insertText(text: string, instanceId: string, offset: number) {\n        const instance = this.getInstance(instanceId);\n        const pos = this.getStartPos(instance) + offset;\n        this.combinedMathText.insertText(pos, text);\n        instance.postInsert();\n    }\n\n    public removeText(instance: MathInstance, start: number, end: number) {\n        const startPos = this.getStartPos(instance);\n        this.combinedMathText.removeRange(startPos + start, startPos + end);\n    }\n\n    public getInstance(id: string, options = MathInstance.defaultOptions) {\n        let _options = options;\n        const endId = endIdPrefix + id;\n        const mathMarker = this.combinedMathText.getMarkerFromId(endId) as IMathMarkerInst;\n        if (mathMarker !== undefined) {\n            if (!mathMarker.mathInstance) {\n                if (mathMarker.properties.componentOptions) {\n                    _options = mathMarker.properties.componentOptions;\n                }\n                mathMarker.mathInstance = new MathInstance(id, this.runtime.objectsRoutingContext, this, _options, true);\n            }\n            return mathMarker.mathInstance as MathInstance;\n        }\n    }\n\n    private getStartPos(instance: MathInstance) {\n        const sharedString = this.combinedMathText;\n        const startMarker = instance.startMarker;\n        const start = getPosition(sharedString, startMarker);\n        return start + startMarker.cachedLength;\n    }\n\n    private findTile(startPos: number, tileType: string, preceding: boolean) {\n        return this.combinedMathText.findTile(startPos, tileType, preceding);\n    }\n\n    private initialize() {\n        // eslint-disable-next-line @typescript-eslint/no-require-imports, import/no-internal-modules, import/no-unassigned-import\n        require(\"katex/dist/katex.min.css\");\n        // eslint-disable-next-line @typescript-eslint/no-require-imports, import/no-unassigned-import\n        require(\"./index.css\");\n\n        this.combinedMathText.on(\"sequenceDelta\", (event) => {\n            if ((!event.isLocal) && (event.ranges.length > 0) && (event.clientId !== \"original\")) {\n                let pos: number;\n                let len = 0;\n                event.ranges.forEach((range) => {\n                    pos = range.position;\n                    len += range.segment.cachedLength;\n                });\n                // console.log(`got event from ${event.clientId} pos: ${pos}`);\n                const tileInfo = this.findTile(pos, \"math\", false);\n                if (tileInfo && (tileInfo.tile.properties.mathEnd)) {\n                    const mathMarker = tileInfo.tile as IMathMarkerInst;\n                    const leafId = mathMarker.getId().substring(endIdPrefix.length);\n                    const instance = this.getInstance(leafId);\n                    const startPos = this.getStartPos(instance);\n                    instance.remoteEdit(pos - startPos, len, event.deltaOperation === MergeTree.MergeTreeDeltaType.INSERT);\n                }\n            }\n        });\n    }\n}\n\nexport const fluidExport: IFluidDataStoreFactory = MathCollection.getFactory();\n"]}